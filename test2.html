<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recording Example</title>
    <script type="text/javascript" src="scripts/sha.js"></script>
</head>
<body>
    <h2>-----------javascript http sample-----------</h2>
    <form action="" method="post" enctype="multipart/form-data" id="form" name="form_en">
        <pre>
        refText: supermarket
        </pre>
        <input type="button" value="Start Recording" id="startRecord">
        <input type="button" value="Stop Recording" id="stopRecord" disabled>
    </form>

    <script>
        var baseUrl = "https://api.speechsuper.com/";
        var appKey = "16467320730000a7";
        var secretKey = "68078c49b31235e0bf1091ecb9d380b1";
        var coreType = "word.eval.promax"; // Change the coreType according to your needs.
        var refText = "supermarket"; // Change the reference text according to your needs.
        var audioType = "spx"; // Use "spx" since we're recording in WAV format.
        var sampleRate = 16000;
        var userId = "guest";
        var url = baseUrl + coreType;

        var getConnectSig = function () {
            var timestamp = new Date().getTime().toString();
            var sig = new jsSHA(appKey + timestamp + secretKey, 'TEXT').getHash("SHA-1", "HEX");
            return { sig: sig, timestamp: timestamp };
        };
        var getStartSig = function () {
            var timestamp = new Date().getTime().toString();
            var sig = new jsSHA(appKey + timestamp + userId + secretKey, 'TEXT').getHash("SHA-1", "HEX");
            return { sig: sig, timestamp: timestamp, userId: userId };
        };
        var createUUID = (function (uuidRegEx, uuidReplacer) {
            return function () {
                return "xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(uuidRegEx, uuidReplacer).toUpperCase();
            };
        })(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0,
                v = c == "x" ? r : (r & 3 | 8);
            return v.toString(16);
        });

        var connectSig = getConnectSig();
        var startSig = getStartSig();
        var params = {
            connect: {
                cmd: "connect",
                param: {
                    sdk: {
                        version: 16777472,
                        source: 9,
                        protocol: 2
                    },
                    app: {
                        applicationId: appKey,
                        sig: connectSig.sig,
                        timestamp: connectSig.timestamp
                    }
                }
            },
            start: {
                cmd: "start",
                param: {
                    app: {
                        applicationId: appKey,
                        sig: startSig.sig,
                        userId: startSig.userId,
                        timestamp: startSig.timestamp
                    },
                    audio: {
                        audioType: audioType,
                        sampleRate: sampleRate,
                        channel: 1,
                        sampleBytes: 2
                    },
                    request: {
                        coreType: coreType,
                        refText: refText,
                        tokenId: createUUID()
                    }
                }
            }
        };

        let mediaRecorder;
        let audioChunks = [];

        document.getElementById("startRecord").onclick = async function() {
            // Request microphone access
            let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = function(event) {
                audioChunks.push(event.data);
            };

            mediaRecorder.start();
            document.getElementById("startRecord").disabled = true;
            document.getElementById("stopRecord").disabled = false;
        };

        document.getElementById("stopRecord").onclick = function() {
            mediaRecorder.stop();
            document.getElementById("startRecord").disabled = false;
            document.getElementById("stopRecord").disabled = true;

            mediaRecorder.onstop = function() {
                let audioBlob = new Blob(audioChunks);
                let fd = new FormData(document.getElementById("form"));
                fd.append("audio", audioBlob, "recording.spx");
                fd.append("text", JSON.stringify(params));

                let xhr = new XMLHttpRequest();
                xhr.open("post", url);
                xhr.setRequestHeader("Request-Index", "0");
                xhr.send(fd);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        console.log(JSON.parse(xhr.responseText).result);
                    }
                };
            };
        };
    </script>
</body>
</html>
